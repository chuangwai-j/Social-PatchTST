# Social-PatchTST: åŸºäºç¤¾äº¤äº¤äº’çš„èˆªç©ºè½¨è¿¹é¢„æµ‹æ¨¡å‹

## ğŸ¯ é¡¹ç›®æ¦‚è¿°

Social-PatchTST æ˜¯ä¸€ä¸ªä¸“ä¸ºèˆªç©ºè½¨è¿¹é¢„æµ‹è®¾è®¡çš„æ·±åº¦å­¦ä¹ é¡¹ç›®ï¼Œç»“åˆäº† PatchTST æ—¶åºå»ºæ¨¡èƒ½åŠ›å’Œç¤¾äº¤äº¤äº’æ„ŸçŸ¥æœºåˆ¶ã€‚æœ¬é¡¹ç›®ä¸ä»…æä¾›å®Œæ•´çš„æ•°æ®å¤„ç†ç®¡é“ï¼Œè¿˜å®ç°äº†ä¸€ä¸ªåˆ›æ–°çš„ç¤¾äº¤æ„ŸçŸ¥è½¨è¿¹é¢„æµ‹æ¨¡å‹ï¼Œèƒ½å¤ŸåŒæ—¶å¤„ç†ç‹¬è‡ªé£è¡Œå’Œå¤šæœºäº¤äº’åœºæ™¯ã€‚

## ğŸ—ï¸ æ ¸å¿ƒæ¶æ„

### ğŸ“Š æ•°æ®å¤„ç†ç®¡é“
- **èˆªç©ºçº§æ•°æ®è´¨é‡**ï¼šåœ†å‘¨æ’å€¼è§£å†³èˆªå‘è§’è·³å˜ï¼Œå¤§åœ†è·ç¦»æ’å€¼ç¡®ä¿ä½ç½®ç²¾åº¦
- **é«˜æ€§èƒ½å¤„ç†**ï¼šNumba JIT åŠ é€Ÿï¼Œå¤šè¿›ç¨‹å¹¶è¡Œå¤„ç†
- **æ™ºèƒ½åœºæ™¯ç”Ÿæˆ**ï¼šè‡ªåŠ¨è¯†åˆ«äº¤äº’åœºæ™¯å’Œç‹¬è‡ªé£è¡Œåœºæ™¯
- **è´¨é‡æ§åˆ¶**ï¼šå¼‚å¸¸å€¼æ£€æµ‹ï¼Œç‰©ç†çº¦æŸéªŒè¯

### ğŸ§  ç¤¾äº¤æ„ŸçŸ¥é¢„æµ‹æ¨¡å‹
- **PatchTST ä¸»å¹²**ï¼šé‡‡ç”¨ Channel-Mixing æ¶æ„çš„æ—¶åºç¼–ç å™¨
- **ç¤¾äº¤äº¤äº’ç¼–ç å™¨**ï¼šåŸºäºç›¸å¯¹ä½ç½®ç¼–ç çš„å¤šæœºäº¤äº’å»ºæ¨¡
- **å¤šä»»åŠ¡é¢„æµ‹å¤´**ï¼šä½ç½®ã€é«˜åº¦ã€é€Ÿåº¦ã€æœ€å°è·ç¦»çš„è”åˆé¢„æµ‹
- **å…¬å¹³å¯¹æ¯”å®éªŒ**ï¼šBaseline æ¨¡å¼ vs Social-PatchTST æ¨¡å¼

## ğŸ“ é¡¹ç›®ç»“æ„

```
Social-PatchTST/
â”œâ”€â”€ ğŸ“‚ data/                           # æ•°æ®å¤„ç†æ¨¡å—
â”‚   â”œâ”€â”€ ğŸ“‚ calculate/                  # æ•°æ®ç»Ÿè®¡åˆ†æ
â”‚   â”‚   â””â”€â”€ calculate_statistics.py    # ç‰¹å¾ç»Ÿè®¡è®¡ç®—
â”‚   â”œâ”€â”€ ğŸ“‚ dataset/                    # æ•°æ®é›†åŠ è½½å™¨
â”‚   â”‚   â””â”€â”€ scene_dataset.py          # åœºæ™¯æ•°æ®é›†ç±»
â”‚   â””â”€â”€ ğŸ“‚ scene_create/               # åœºæ™¯ç”Ÿæˆå·¥å…·
â”‚       â””â”€â”€ pick_and_copy.py          # åœºæ™¯é€‰æ‹©ä¸å¤åˆ¶
â”‚
â”œâ”€â”€ ğŸ“‚ model/                          # æ¨¡å‹å®šä¹‰
â”‚   â”œâ”€â”€ patchtst.py                   # PatchTST æ—¶åºç¼–ç å™¨
â”‚   â”œâ”€â”€ social_patchtst.py            # ä¸»æ¨¡å‹ï¼ˆé›†æˆç‰ˆï¼‰
ï¿½ï¿½   â”œâ”€â”€ social_transformer.py         # ç¤¾äº¤äº¤äº’ç¼–ç å™¨
â”‚   â”œâ”€â”€ prediction_decoder.py         # å¤šä»»åŠ¡é¢„æµ‹å¤´
â”‚   â””â”€â”€ relative_position_encoding.py  # ç›¸å¯¹ä½ç½®ç¼–ç 
â”‚
â”œâ”€â”€ ğŸ“‚ tools/                          # å·¥å…·è„šæœ¬
â”‚   â”œâ”€â”€ train.py                      # è®­ç»ƒè„šæœ¬ï¼ˆå«å¯¹æ¯”å®éªŒï¼‰
â”‚   â””â”€â”€ inference.py                  # æ¨ç†è„šæœ¬
â”‚
â”œâ”€â”€ ğŸ“‚ config/                         # é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ config_manager.py             # é…ç½®ç®¡ç†å™¨
â”‚   â””â”€â”€ social_patchtst_config.yaml   # ä¸»é…ç½®æ–‡ä»¶
â”‚
â”œâ”€â”€ ğŸ“‚ checkpoints/                    # æ¨¡å‹æ£€æŸ¥ç‚¹
â”œâ”€â”€ ğŸ“‚ logs/                          # è®­ç»ƒæ—¥å¿—å’Œtensorboard
â”œâ”€â”€ ğŸ“‚ metrics_calculation/           # è®­ç»ƒæŒ‡æ ‡å’Œè®¡ç®—ç»“æœ
â””â”€â”€ ğŸ“‚ photo/                         # é¡¹ç›®ç›¸å…³å›¾ç‰‡
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

```bash
# æ·±åº¦å­¦ä¹ æ¡†æ¶
torch >= 1.9.0
torchvision >= 0.10.0

# æ•°æ®å¤„ç†
pandas >= 1.3.0
numpy >= 1.21.0
tqdm >= 4.62.0
scikit-learn >= 1.0.0

# æ€§èƒ½ä¼˜åŒ–
numba >= 0.56.0
pyproj >= 3.2.0

# å¯è§†åŒ–å’Œç›‘æ§
tensorboard >= 2.8.0
matplotlib >= 3.5.0
```

### å®‰è£…ä¾èµ–

```bash
pip install torch torchvision pandas numpy tqdm scikit-learn numba pyproj tensorboard matplotlib
```

### ğŸ¯ è®­ç»ƒæ¨¡å‹

#### 1. Social-PatchTST æ¨¡å‹ï¼ˆå®Œæ•´ç¤¾äº¤äº¤äº’ï¼‰
```bash
python tools/train.py --config config/social_patchtst_config.yaml
```

#### 2. Baseline æ¨¡å‹ï¼ˆå¯¹æ¯”å®éªŒï¼‰
```bash
python tools/train.py --config config/social_patchtst_config.yaml --baseline
```

#### 3. æµ‹è¯•æ•°æ®åŠ è½½
```bash
python tools/train.py --config config/social_patchtst_config.yaml --test
```

### ğŸ“Š æ¨ç†ä½¿ç”¨
```bash
python tools/inference.py --model-path checkpoints/best_model.pth --config config/social_patchtst_config.yaml
```

## ğŸ”§ æ¨¡å‹é…ç½®

### æ ¸å¿ƒé…ç½®å‚æ•°
```yaml
# PatchTST é…ç½®
patchtst_config:
  patch_length: 16
  stride: 8
  d_model: 512
  n_heads: 8
  n_layers: 6

# ç¤¾äº¤ç¼–ç å™¨é…ç½®
social_config:
  max_aircrafts: 50
  d_social: 512
  n_heads: 8
  n_layers: 4

# è®­ç»ƒé…ç½®
training:
  batch_size: 32
  learning_rate: 0.0001
  epochs: 100
  patience: 10

# æ•°æ®é…ç½®
data:
  history_length: 600  # 10åˆ†é’Ÿå†å²
  prediction_length: 120  # 2åˆ†é’Ÿé¢„æµ‹
  max_neighbors: 20
```

## ğŸ“ˆ è®­ç»ƒæŒ‡æ ‡å’Œæ€§èƒ½

### ğŸ¯ è‡ªåŠ¨è®°å½•çš„æŒ‡æ ‡
è®­ç»ƒè¿‡ç¨‹ä¼šè‡ªåŠ¨è®°å½•ä»¥ä¸‹æ€§èƒ½æŒ‡æ ‡ï¼š

#### æŸå¤±å‡½æ•°
- `train_total_loss`: è®­ç»ƒæ€»æŸå¤±
- `val_total_loss`: éªŒè¯æ€»æŸå¤±
- `position_loss`: ä½ç½®é¢„æµ‹æŸå¤±
- `altitude_loss`: é«˜åº¦é¢„æµ‹æŸå¤±
- `velocity_loss`: é€Ÿåº¦é¢„æµ‹æŸå¤±
- `mindist_loss`: æœ€å°è·ç¦»é¢„æµ‹æŸå¤±

#### æ€§èƒ½æŒ‡æ ‡
- `val_position_rmse`: ä½ç½®é¢„æµ‹å‡æ–¹æ ¹è¯¯å·®
- `val_altitude_rmse`: é«˜åº¦é¢„æµ‹å‡æ–¹æ ¹è¯¯å·®
- `val_velocity_rmse`: é€Ÿåº¦é¢„æµ‹å‡æ–¹æ ¹è¯¯å·®
- `val_position_mae`: ä½ç½®é¢„æµ‹å¹³å‡ç»å¯¹è¯¯å·®
- `val_altitude_mae`: é«˜åº¦é¢„æµ‹å¹³å‡ç»å¯¹è¯¯å·®
- `val_velocity_mae`: é€Ÿåº¦é¢„æµ‹å¹³å‡ç»å¯¹è¯¯å·®
- `val_far`: è™šè­¦ç‡ï¼ˆç¤¾äº¤æ¨¡å‹ç‰¹æœ‰æŒ‡æ ‡ï¼‰

### ğŸ“Š ç»“æœè¾“å‡º
è®­ç»ƒå®Œæˆåä¼šç”Ÿæˆï¼š
- `./metrics_calculation/final_training_metrics.json`: å®Œæ•´è®­ç»ƒæŒ‡æ ‡
- `./checkpoints/best_model.pth`: æœ€ä½³æ¨¡å‹æƒé‡
- `./logs/tensorboard/`: TensorBoard å¯è§†åŒ–æ—¥å¿—
- `./metrics_calculation/training_metrics_epoch_{N}.json`: æ¯5è½®çš„ä¸­é—´æŒ‡æ ‡

## ğŸ§ª å¯¹æ¯”å®éªŒè®¾è®¡

### ğŸ¯ ç§‘å­¦ä¸¥è°¨çš„å¯¹æ¯”
æœ¬é¡¹ç›®å®ç°äº†å®Œç¾çš„å¯¹æ¯”å®éªŒè®¾è®¡ï¼š

- **Social-PatchTST**: CM-PatchTST + ç¤¾äº¤ç¼–ç å™¨
- **Baseline**: CM-PatchTST + é›¶ç¤¾äº¤è¾“å…¥

### âœ… å…¬å¹³æ€§ä¿è¯
- 99% ä»£ç å…±äº«ï¼Œåªéš”ç¦»ç¤¾äº¤æ¨¡å—
- ç›¸åŒçš„æ•°æ®åŠ è½½å™¨å’Œé¢„å¤„ç†
- ç›¸åŒçš„è®­ç»ƒè¶…å‚æ•°å’Œä¼˜åŒ–ç­–ç•¥
- ç›¸åŒçš„è¯„ä¼°æŒ‡æ ‡å’Œå¯è§†åŒ–

### ğŸ“‹ å®éªŒç»“æœåˆ†æ
å¯¹æ¯”å®éªŒå¯ä»¥ç›´æ¥ç”¨äºè®ºæ–‡ï¼š
- **æ€§èƒ½æå‡é‡åŒ–**: ç¤¾äº¤ä¿¡æ¯å¸¦æ¥çš„å…·ä½“æå‡å¹…åº¦
- **æ¶ˆèå®éªŒ**: éªŒè¯ SocialEncoder çš„æœ‰æ•ˆæ€§
- **è®­ç»ƒæ›²çº¿å¯¹æ¯”**: å¯è§†åŒ–å­¦ä¹ è¿‡ç¨‹å·®å¼‚

## ğŸ“Š æ•°æ®æ ¼å¼

### è¾“å…¥æ•°æ®æ ¼å¼
æ”¯æŒ CSV æ ¼å¼çš„ ADS-B æ•°æ®ï¼š
```csv
target_address,callsign,timestamp,latitude,longitude,flight_level,ground_speed,track_angle,vertical_rate,selected_altitude,aircraft_type
```

### åœºæ™¯æ•°æ®ç»“æ„
```
scenes/
â”œâ”€â”€ train_paths.txt          # è®­ç»ƒåœºæ™¯è·¯å¾„åˆ—è¡¨
â”œâ”€â”€ val_paths.txt            # éªŒè¯åœºæ™¯è·¯å¾„åˆ—è¡¨
â”œâ”€â”€ test_paths.txt           # æµ‹è¯•åœºæ™¯è·¯å¾„åˆ—è¡¨
â””â”€â”€ [scene_id]/
    â”œâ”€â”€ ego.csv              # ä¸»é£è¡Œå™¨æ•°æ®
    â””â”€â”€ neighbors.csv        # é‚»å±…é£è¡Œå™¨æ•°æ®
```

## ğŸ§  æ¨¡å‹æ¶æ„è¯¦è§£

### ğŸ”¥ PatchTST æ—¶åºç¼–ç å™¨
- **Patch é•¿åº¦**: 16 ä¸ªæ—¶é—´æ­¥
- **æ»‘åŠ¨æ­¥é•¿**: 8 ä¸ªæ—¶é—´æ­¥
- **è¾“å‡ºç»´åº¦**: [N, n_patches=14, d_model=512]

### ğŸ‘¥ ç¤¾äº¤äº¤äº’ç¼–ç å™¨
- **æœ€å¤§é£æœºæ•°**: 50 æ¶
- **ç›¸å¯¹ä½ç½®ç¼–ç **: åŸºäºè·ç¦»çš„é‚»å±…æƒé‡
- **è¾“å‡ºç»´åº¦**: [N, T=120, d_social=512]

### ğŸ¯ å¤šä»»åŠ¡é¢„æµ‹å¤´
- **ä½ç½®é¢„æµ‹**: [N, T_out, 2] â†’ latitude, longitude
- **é«˜åº¦é¢„æµ‹**: [N, T_out, 1] â†’ flight_level
- **é€Ÿåº¦é¢„æµ‹**: [N, T_out, 2] â†’ vx, vy
- **æœ€å°è·ç¦»**: [N, T_out, 1] â†’ mindist_nm

### ğŸ”„ ç‰¹å¾èåˆ
- æ—¶åºç‰¹å¾ + ç¤¾äº¤ç‰¹å¾ â†’ [N, 14, 1024]
- è‡ªé€‚åº”æ± åŒ–å¯¹é½ç»´åº¦
- æ®‹å·®è¿æ¥å¢å¼ºæ¢¯åº¦æµ

## ğŸš€ æ€§èƒ½åŸºå‡†

### ğŸ“Š æ¨¡å‹è§„æ¨¡
- **æ€»å‚æ•°é‡**: 22.78M
- **æ—¶åºç¼–ç å™¨**: 14.2M å‚æ•°
- **ç¤¾äº¤ç¼–ç å™¨**: 6.8M å‚æ•°
- **é¢„æµ‹è§£ç å™¨**: 1.78M å‚æ•°

### ğŸ¯ é¢„æµ‹ç²¾åº¦

ï¼ˆå¾…è®­ç»ƒå®Œæˆåå¡«å†™å…·ä½“æ€§èƒ½æŒ‡æ ‡ï¼‰

## ğŸ› ï¸ æŠ€æœ¯ç‰¹ç‚¹

### âœ¨ åˆ›æ–°ç‚¹
1. **ç¤¾äº¤æ„ŸçŸ¥æ—¶åºå»ºæ¨¡**: é¦–æ¬¡å°†ç¤¾äº¤äº¤äº’é›†æˆåˆ° PatchTST æ¶æ„
2. **å…¬å¹³å¯¹æ¯”å®éªŒ**: å®Œç¾éš”ç¦»ç¤¾äº¤æ¨¡å—è´¡çŒ®çš„ç§‘å­¦è¯„ä¼°
3. **å¤šä»»åŠ¡è”åˆå­¦ä¹ **: åŒæ—¶ä¼˜åŒ–è½¨è¿¹é¢„æµ‹å’Œå®‰å…¨æŒ‡æ ‡
4. **å·¥ç¨‹åŒ–å®ç°**: ç«¯åˆ°ç«¯çš„è®­ç»ƒæ¨ç†ç®¡é“

### ğŸ”§ å·¥ç¨‹ä¼˜åŒ–
- **æ··åˆç²¾åº¦è®­ç»ƒ**: åŠ é€Ÿè®­ç»ƒï¼Œé™ä½å†…å­˜ä½¿ç”¨
- **æ¢¯åº¦è£å‰ª**: é˜²æ­¢æ¢¯åº¦çˆ†ç‚¸
- **æ—©åœæœºåˆ¶**: é¿å…è¿‡æ‹Ÿåˆ
- **æ£€æŸ¥ç‚¹ç®¡ç†**: è‡ªåŠ¨ä¿å­˜æœ€ä½³æ¨¡å‹

### ğŸ“ˆ å¯æ‰©å±•æ€§
- **æ¨¡å—åŒ–è®¾è®¡**: æ˜“äºæ›¿æ¢å’Œæ‰©å±•å„ç»„ä»¶
- **é…ç½®é©±åŠ¨**: é€šè¿‡YAMLæ–‡ä»¶çµæ´»è°ƒæ•´è¶…å‚æ•°
- **å¤šGPUæ”¯æŒ**: æ”¯æŒåˆ†å¸ƒå¼è®­ç»ƒ
- **ONNXå¯¼å‡º**: æ”¯æŒæ¨¡å‹éƒ¨ç½²ä¼˜åŒ–

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### è®­ç»ƒè„šæœ¬ç¤ºä¾‹
```python
from tools.train import Trainer

# åˆ›å»ºè®­ç»ƒå™¨
trainer = Trainer(
    config_path='config/social_patchtst_config.yaml',
    is_baseline=False  # Falseä¸ºSocialæ¨¡å¼ï¼ŒTrueä¸ºBaselineæ¨¡å¼
)

# å¼€å§‹è®­ç»ƒ
final_metrics_file = trainer.train()

print(f"è®­ç»ƒå®Œæˆï¼ç»“æœä¿å­˜åœ¨: {final_metrics_file}")
```

### æ¨ç†è„šæœ¬ç¤ºä¾‹
```python
from model import create_model
import torch

# åŠ è½½æ¨¡å‹
model = create_model('config/social_patchtst_config.yaml')
model.load_state_dict(torch.load('checkpoints/best_model.pth'))
model.eval()

# æ¨ç†
with torch.no_grad():
    predictions = model.predict(batch_data)
```